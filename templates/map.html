<html>
<head>
    <title>deck.gl ColumnLayer Example</title>

    
    <script src="https://d3js.org/d3.v5.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/global.css" />
    <link rel="stylesheet" href="static/map.css" />
</head>

<body>
    <div class="sidebar-frame5">
        <img
          class="logo-icon5"
          alt=""
          src="/static/public/logo@2x.png"
          id="logoImage"
        />

        <div class="world-icon-parent3">
          <img
            class="world-icon5"
            alt=""
            src="/static/public/world-icon@2x.png"
            id="worldIcon"
          />

          <img
            class="world-icon5"
            alt=""
            src="/static/public/table-icon@2x.png"
            id="tableIcon"
          />

          <img
            class="camera-icon5"
            alt=""
            src="/static/public/camera-icon@2x.png"
            id="cameraICon"
          />
        </div>
        <div class="user-icon-parent3">
          <img
            class="world-icon5"
            alt=""
            src="/static/public/user-icon@2x.png"
            id="userIcon"
          />

          <img
            class="world-icon5"
            alt=""
            src="/static/public/settings-icon@2x.png"
            id="settingsIcon"
          />
        </div>
      </div>
<div class="frame-parent1" id="map"></div>
<div class="ui-container">
    <div class="filters-wrapper">
        <b class="filters1">Filters</b>
      </div>
    <form id="formData" action="/map" method="post">
        <div class="text" id="layerForm">
            <text class="text">Layer: </text><br>
            <input class="text" type="radio" id="rgn" name="layer" value="rgn" required>
            <label for="rgn">Region</label><br>
            <input class="text" type="radio" id="itl" name="layer" value="itl">
            <label for="itl">ITL</label><br>
            <input class="text" type="radio" id="lad" name="layer" value="lad">
            <label for="lad">LAD</label><br>
        </div>
        <div class="text" id="ageForm">
            <label for="start_age">Start Age:</label>
            <input class="lower-value2" type="number" id="start_age" name="start_age" min="0" max="95"><br>
            <label for="end_age">End Age:</label>
            <input class="lower-value2" type="number" id="end_age" name="end_age" min="0" max="95"><br>
        </div>
        <div class="text" id="sexForm">
            <text class="text">Sex: </text><br>
            <input class="text" type="radio" id="male" name="sex" value="male" required>
            <label for="male">Male</label><br>
            <input class="text" type="radio" id="female" name="sex" value="female">
            <label for="female">Female</label><br>
            <input class="text" type="radio" id="persons" name="sex" value="persons">
            <label for="persons">Both</label><br>
        </div>
        <div class="slidecontainer">
          <text>Year:</text>
          <input type="range" min="24168" max="24300" value = "24291" class="slider" id="year" name="year">
          <text class="smalltext">Value: <span id="demo"></span></text>
        </div>
        <div class="text" id="removeForm">
          <label for="remove">Remove:</label>
          <input class="text" type="text" id="remove" name="remove">
        </div>
        <button type="submit" class="log-in-container">
            <div class="log-in2">Submit</div>
        </button>
    </form>
    <button class="button" id="toggleStatsBtn">Show stats</button>
</div>


<div class="stats-box" style="display: none;">
  <div class="filters-wrapper">
      <b class="filters1">General Stats:</b>
    </div>
          <u class="text">Total Population: </u><br>
          <text class="text">{{pop}}</text><br>
          <u class="text">Largest changes in the last year: </u><br>
        <div class="cities">
          <div class="section">
            <text class="text"> 1. {{trends[0][0]}} </text>
            <text class="text">↑ {{trends[0][1]}}%</text>
          </div>
          <div class="section">
            <text class="text"> 2. {{trends[1][0]}} </text>
            <text class="text">↑ {{trends[1][1]}}%</text>
          </div>
          <div class="section">
            <text class="text"> 3. {{trends[2][0]}}  </text>
            <text class="text">↑ {{trends[2][1]}}%</text>
          </div>
          <div class="section">
            <text class="text"> 4. {{trends[3][0]}}</text>
            <text class="text">↑ {{trends[3][1]}}%</text>
          </div>
          <div class="section">
            <text class="text"> 5. {{trends[4][0]}} </text>
            <text class="text">↑ {{trends[4][1]}}%</text>
          </div>
          <div class="section">
            <text class="text"> 6. {{trends[5][0]}} </text>
            <text class="text">↑ {{trends[5][1]}}%</text>
          </div>
        </div>
</div>

<div id="tooltip"></div>

<div id="message-container">
  <p id="message" style="color: rgb(0, 0, 0);"></p>
  
</div>

<script>
    document.getElementById('formData').addEventListener('submit', function(event) {
    const startAge = parseInt(document.getElementById('start_age').value);
    const endAge = parseInt(document.getElementById('end_age').value);
    
    if (startAge > endAge) {
        // Prevent form submission
        event.preventDefault();
        // Display an alert message or any other indication to the user
        alert("Start age must be equal to or lower than end age.");
    } else {
        // Start age is equal to or lower than end age, proceed with form submission
        storeFormData();
    }
});


    const token = 'pk.eyJ1IjoiZGlhbmFtZW93IiwiYSI6ImNqcmh4aWJnOTIxemI0NXA0MHYydGwzdm0ifQ.9HakB25m0HLT-uDY2yat7A';
    const data = {{ DATA|safe }};
    const startAge = {{ start_age }};
    const endAge = {{ end_age }};
    const maxElevation = {{ max_elevation }};
    const minElevation = {{ min_elevation }};
    const scale = {{ scale }};
    const selectedLayer = '{{ selected_layer }}';
    const radius = {{ radius }};


    
    const { DeckGL, ColumnLayer } = deck;

    const getTooltipContent = (d) => {
        let tooltipContent = '';
        if (selectedLayer === 'lad') {
            tooltipContent = `<div>LAD: ${d.LAD}</div><div>ITL: ${d.ITL}</div><div>Region: ${d.Region}</div><div>Elevation: ${d.elevation}</div>`;
        } else if (selectedLayer === 'itl') {
            tooltipContent = `<div>ITL: ${d.ITL}</div><div>Region: ${d.Region}</div><div>Elevation: ${d.elevation}</div>`;
        } else if (selectedLayer === 'rgn') {
            tooltipContent = `<div>Region: ${d.Region}</div><div>Elevation: ${d.elevation}</div>`;
        }
        return tooltipContent;
    };

    new DeckGL({
        mapboxApiAccessToken: token,
        mapStyle: 'mapbox://styles/mapbox/dark-v10',
        initialViewState: {
            container: 'map',
            longitude: -1.932311,
            latitude: 51.923,
            pitch: 60,
            bearing: 0,
            minZoom: 5,
            zoom: 7,
        },

        controller: true,
        layers: [
            new ColumnLayer({
                id: 'column',
                data: data,
                diskResolution: 12,
                radius: radius,
                elevationScale: scale,
                getPosition: (d) => [d.Longitude, d.Latitude],
                getFillColor: (d) => [d.red, d.green, d.blue, 160],
                getElevation: (d) => d.elevation,
                pickable: true,
                onHover: ({ object, x, y }) => {
                    const el = document.getElementById('tooltip');
                    if (object) {

                        const tooltipContent = getTooltipContent(object);
                        el.innerHTML = tooltipContent;;
                        el.style.display = 'block';
                        el.style.opacity = 0.9;
                        el.style.left = x + 'px';
                        el.style.top = y + 'px';
                    } else {
                        el.style.opacity = 0.0;
                    }
                },
            }),
        ],
    });


    // Add event listener for radio button change
    document.getElementById('layerForm').addEventListener('change', function(event) {
        const selectedLayer = event.target.value;
        console.log(selectedLayer); // You can do further processing based on the selected layer
        // Update layers based on the selected layer
        // For example, you may want to fetch different data based on the selected layer and update the ColumnLayer
    });

    

    // Function to store form data in local storage
    function storeFormData() {
        var formData = {
            layer: document.querySelector('input[name="layer"]:checked').value,
            start_age: document.getElementById('start_age').value,
            end_age: document.getElementById('end_age').value,
            sex: document.querySelector('input[name="sex"]:checked').value,
            yearslider: document.getElementById('year').value,
            value: document.getElementById('demo').innerHTML,
        };
        
        localStorage.setItem('formData', JSON.stringify(formData));
    }
    var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  

    const datecorrectionyear = "{{ datecorrection[0] }}"
    const datecorrectionmonth = Number("{{ datecorrection[1] }}")-1 // Subtract 1 because JavaScript uses 0-based index for months
    

    // Function to retrieve and populate form data from local storage
    function populateFormData() {
      var storedFormData = JSON.parse(localStorage.getItem('formData'));
      if ('{{ datecorrection }}' != '') {
        formData.yearslider = datecorrectionyear*12+datecorrectionmonth
        formData.value = datecorrectionyear+" "+ months[datecorrectionmonth]
      }
      else {
        formData.yearslider = storedFormData.yearslider;
        formData.value = storedFormData.value;
      }
        if (storedFormData) {
            document.querySelector(`input[name="layer"][value="${storedFormData.layer}"]`).checked = true;
            document.getElementById('start_age').value = storedFormData.start_age;
            document.getElementById('end_age').value = storedFormData.end_age;
            document.querySelector(`input[name="sex"][value="${storedFormData.sex}"]`).checked = true;
            document.getElementById('year').value = formData.yearslider;
            document.getElementById('demo').innerHTML = formData.value;
        }
    }

    // Function to set message
    function setMessage(message) {
        const messageElement = document.getElementById('message');
        if (messageElement) {
            messageElement.textContent = message;
        }
    }

    // Check if message exists and display it
    const message = "{{ message }}";
    if (message) {
        setMessage(message);
    }

    // Add event listener for form submission
    document.getElementById('formData').addEventListener('submit', function(event) {
        storeFormData();
    });

    // Populate form data when the page loads
    window.addEventListener('DOMContentLoaded', function() {
        populateFormData();
    });

    var logoImage = document.getElementById("logoImage");
      if (logoImage) {
        logoImage.addEventListener("click", function (e) {
          window.location.href = "/dashboard";
        });
      }
      
      var worldIcon = document.getElementById("worldIcon");
      if (worldIcon) {
        worldIcon.addEventListener("click", function (e) {
          window.location.href = "/map";
        });
      }
      
      var tableIcon = document.getElementById("tableIcon");
      if (tableIcon) {
        tableIcon.addEventListener("click", function (e) {
          window.location.href = "/analytics";
        });
      }
      
      var cameraICon = document.getElementById("cameraICon");
      if (cameraICon) {
        cameraICon.addEventListener("click", function (e) {
          window.location.href = "/snapshot";
        });
      }
      
      var userIcon = document.getElementById("userIcon");
      if (userIcon) {
        userIcon.addEventListener("click", function (e) {
          window.location.href = "/account";
        });
      }
      
      var settingsIcon = document.getElementById("settingsIcon");
      if (settingsIcon) {
        settingsIcon.addEventListener("click", function (e) {
          window.location.href = "/settings";
        });
      }

      function getMonthName(value) {
        var year = Math.floor(value / 12); // Calculate the year
        var monthIndex = value % 12; // Get the index of the month in the array
        var month = months[monthIndex]; // Get the month name
        return year + ' ' + month; // Concatenate year and month
      }
      function formatDateString(dateArray) {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const year = dateArray[0];
        const monthIndex = parseInt(dateArray[1]) - 1; // Subtract 1 because JavaScript uses 0-based index for months
        const month = months[monthIndex];
        
        return year + ' ' + month;
      }
      var slider = document.getElementById("year");
      var output = document.getElementById("demo");
      
      
      // Update the current slider value (each time you drag the slider handle)
      slider.oninput = function() {
      output.innerHTML = getMonthName(this.value);

      
      }

      // Show/hide stats box
      document.getElementById('toggleStatsBtn').addEventListener('click', function() {
          const statsBox = document.querySelector('.stats-box');
          const btn = document.getElementById('toggleStatsBtn');
          if (statsBox.style.display === 'none') {
              statsBox.style.display = 'block';
              btn.textContent = 'Hide stats';
          } else {
              statsBox.style.display = 'none';
              btn.textContent = 'Show stats';
          }
      });
</script>
<!-- Full page image -->
<div class="full-page-image">
  <img src="/static/public/mapbasepic.png" alt="" width="100%" height="100%" >
</div>
<div class="background">
  <img src="/static/public/greybg.png" alt="" width="100%" height="100%" >
</div>


</body>
</html>
