<html>
<head>
    <title>deck.gl ColumnLayer Example</title>

    <script src="https://unpkg.com/deck.gl@^8.8.0/dist.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet"/>

    <style type="text/css">
        body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
            z-index: 0; 
        }
        .ui-container {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border-radius: 5px;
            z-index: 1; 
        }
    </style>
</head>

<body>
<div id="map"></div>
<div class="ui-container">
    <form id="formData" action="/map" method="post">
        <div id="layerForm">
            <input type="radio" id="rgn" name="layer" value="rgn" required>
            <label for="rgn">Region</label><br>
            <input type="radio" id="itl" name="layer" value="itl">
            <label for="itl">ITL</label><br>
            <input type="radio" id="lad" name="layer" value="lad">
            <label for="lad">LAD</label><br>
        </div>
        <div id="ageForm">
            <label for="start_age">Start Age:</label>
            <input type="number" id="start_age" name="start_age" min="0" max="95"><br>
            <label for="end_age">End Age:</label>
            <input type="number" id="end_age" name="end_age" min="0" max="95"><br>
        </div>
        <div id="sexForm">
            <input type="radio" id="male" name="sex" value="male" required>
            <label for="male">Male</label><br>
            <input type="radio" id="female" name="sex" value="female">
            <label for="female">Female</label><br>
            <input type="radio" id="persons" name="sex" value="persons">
            <label for="persons">Both</label><br>
        </div>
        <input type="submit" value="Submit">
    </form>
</div>

<script>
    const token = 'pk.eyJ1IjoiZGlhbmFtZW93IiwiYSI6ImNqcmh4aWJnOTIxemI0NXA0MHYydGwzdm0ifQ.9HakB25m0HLT-uDY2yat7A';
    const data = {{ DATA|safe }};
    const startAge = {{ start_age }};
    const endAge = {{ end_age }};
    const maxElevation = {{ max_elevation }};
    const minElevation = {{ min_elevation }};
    const scale = {{ scale }};

    const { DeckGL, ColumnLayer } = deck;


    new DeckGL({
        mapboxApiAccessToken: token,
        mapStyle: 'mapbox://styles/mapbox/dark-v10',
        initialViewState: {
            container: 'map',
            longitude: -1.932311,
            latitude: 51.923,
            pitch: 60,
            bearing: 0,
            minZoom: 5,
            zoom: 7,
        },

        controller: true,
        layers: [
            new ColumnLayer({
                id: 'column',
                data: data,
                diskResolution: 12,
                radius: 1000,
                elevationScale: scale,
                getPosition: (d) => [d.Longitude, d.Latitude],
                getFillColor: (d) => [d.red, d.green, 0, 160],
                getElevation: (d) => d.elevation,
            }),
        ],
    });

    // Add event listener for radio button change
    document.getElementById('layerForm').addEventListener('change', function(event) {
        const selectedLayer = event.target.value;
        console.log(selectedLayer); // You can do further processing based on the selected layer
        // Update layers based on the selected layer
        // For example, you may want to fetch different data based on the selected layer and update the ColumnLayer
    });

    // Function to store form data in local storage
    function storeFormData() {
        const formData = {
            layer: document.querySelector('input[name="layer"]:checked').value,
            start_age: document.getElementById('start_age').value,
            end_age: document.getElementById('end_age').value,
            sex: document.querySelector('input[name="sex"]:checked').value
        };
        localStorage.setItem('formData', JSON.stringify(formData));
    }

    // Function to retrieve and populate form data from local storage
    function populateFormData() {
        const storedFormData = JSON.parse(localStorage.getItem('formData'));
        if (storedFormData) {
            document.querySelector(`input[name="layer"][value="${storedFormData.layer}"]`).checked = true;
            document.getElementById('start_age').value = storedFormData.start_age;
            document.getElementById('end_age').value = storedFormData.end_age;
            document.querySelector(`input[name="sex"][value="${storedFormData.sex}"]`).checked = true;
        }
    }

    // Add event listener for form submission
    document.getElementById('formData').addEventListener('submit', function(event) {
        storeFormData();
    });

    // Populate form data when the page loads
    window.addEventListener('DOMContentLoaded', function() {
        populateFormData();
    });
</script>
</body>
</html>
